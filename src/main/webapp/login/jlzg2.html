<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>指悦账号 - 登录</title>
    <meta name="keywords" content="perfect-ssm">
    <meta name="description" content="perfect-ssm">

    <!--    <link href="https://zyh5games.com/zysdk/login/image/style.css?04231428" rel='stylesheet' type='text/css'/>-->
    <link href="https://zyh5games.com/zysdk/images/favicon.ico" rel="shortcut icon" type="image/x-icon"/>
    <!--[if lt IE 9]>
    <meta http-equiv="refresh" content="0;ie.html"/>
    <![endif]-->
    <script src="https://zyh5games.com/zysdk/js/vconsole.min.js"></script>
    <script type="text/javascript"
            src="https://zyh5games.com/zysdk/jquery-easyui-1.7.0/jquery.min.js"></script>
    <script type="text/javascript"
            src="https://zyh5games.com/zysdk/jquery-easyui-1.7.0/jquery.easyui.min.js"></script>
    <script src="https://zyh5games.com/zysdk/bootstrap-3.3.7-dist/js/bootstrap.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
    <script src="https://zyh5games.com/zysdk/js/common.js"></script>
<!--        <script src="https://zyh5games.com/zysdk/js/libZySdk_v2.js?1925"></script>-->
    <script src="https://zyh5games.com/sdk/libZySdk_v2.js?1405"></script>
    <script src="https://zyh5games.com/zysdk/login/h5game.js?1454"></script>

</head>

<body class="gray-bg">

<div hidden="hidden">
    <label for="appId"></label>
    <input type="text" name="appId" id="appId" required="" hidden="hidden">

    <label for="channelId"></label>
    <input type="text" name="channelId" id="channelId" required="" hidden="hidden">

    <label for="uid"></label>
    <input type="text" name="uid" id="uid" required="" hidden="hidden">

    <label for="channelUid"></label>
    <input type="text" name="channelUid" id="channelUid" required="" hidden="hidden">

    <label for="copy"></label>
    <input type="text" name="copy" id="copy" required="" hidden="hidden">
</div>

<script>
    $(function () {
        let appId = 14;
        let GameKey = "u6d3047qbltix34a9l0g2bvs5e8q82ol";
        let channelId = 0;

        let newURl = updateQueryStringParameter(window.location.href, 'GameId', appId);
        newURl = updateQueryStringParameter(newURl, 'GameKey', GameKey);
        newURl = updateQueryStringParameter(newURl, 'ChannelCode', channelId);


        let zy_account = getCookies("zy_account");
        let zy_password = getCookies("zy_password");
        let zy_channelUid = getCookies("zy_channelUid");

        console.info("zy_account=" + zy_account);
        console.info("zy_password=" + zy_password);
        console.info("zy_channelUid=" + zy_channelUid);

        let regInfo = {};
        regInfo.appId = appId;
        regInfo.channelId = channelId;
        regInfo.channelUname = "";
        regInfo.channelUnick = "";
        regInfo.phone = "";
        regInfo.deviceCode = "PC";

        if (channelId === 0) {
            // 指悦官方渠道-无账号自动注册
            if (zy_account === "" || zy_password === "" || zy_channelUid === "") {
                regInfo.channelUid = getZyNextUid();
                autoReg(regInfo);
            } else {
                newURl = updateQueryStringParameter(newURl, 'zy_channelUid', zy_channelUid);
                newURl = updateQueryStringParameter(newURl, 'zy_account', zy_account);
                newURl = updateQueryStringParameter(newURl, 'zy_password', zy_password);
            }
        } else {
            // regInfo.channelUid = getRndInteger(8, 10);
            // autoReg(regInfo);
        }

        //向当前url添加参数，没有历史记录
        // window.history.replaceState({
        //     path: newURl
        // }, '', newURl);

        let res = "账号: " + zy_account + " 密码: " + zy_password;
        $('#copy').val(res);

        // 初始化
        window.vConsole = new window.VConsole();
        console.log('Hello world');
        console.log(window.location.href);

    });
    let clipboard = new ClipboardJS('.copyBtn', {
        text: function () {
            return $("input:hidden[name='copy']").val();
        }
    });
    clipboard.on('success', function (e) {
        alert("已复制到剪贴板" + "\n账号: " + t_name + "\n密码: " + t_pwd);
        // e.clearSelection();
    });

    clipboard.on('error', function (e) {
        console.error('Action:', e.action);
        console.error('Trigger:', e.trigger);
    });
    let is_select = true;
    //给返回首页修改密码按钮添加单击事件
    $("#select-protocol").on("click", function () {
        select_protocol();
    });

    function select_protocol() {
        if (is_select) {
            document.getElementById("select-protocol").className = 'unselected';
            is_select = false;
        } else {
            document.getElementById("select-protocol").className = 'icon-select';
            is_select = true;
        }
    }

    function showRegPage() {
        //隐藏
        document.getElementById("login").hidden = true;
        //显示
        document.getElementById("reg").hidden = false;
    }

    function showLoginPage() {
        //显示
        document.getElementById("login").hidden = false;
        //隐藏
        document.getElementById("reg").hidden = true;
        document.getElementById("zyreg").hidden = true;
    }

    function changePhonePage() {
        showRegPage();
        // zy_Register();
    }

    function showZyRegPage() {
        //显示
        document.getElementById("zyreg").hidden = false;
        //隐藏
        document.getElementById("reg").hidden = true;
        document.getElementById("login").hidden = true;
    }


    function resetLogin() {
        delCookie("zy_account");
        delCookie("zy_password");
        delCookie("zy_channelUid");
    }

    function getRndInteger(min, max) {
        return Math.floor(Math.random() * (max - min)) + min;
    }

    // 自动注册账号
    function autoReg(regInfo) {
        sdk_AutoReg(regInfo, function (callbackData) {
            if (callbackData.state === false) {
                console.log(callbackData.message);
                alert(callbackData.message);
            } else {
                console.info(callbackData.message);
                console.info(JSON.stringify(callbackData));

                let ZyUid = callbackData.uid;
                let username = callbackData.account;
                let password = callbackData.password;
                let channelUid = callbackData.channelUid;

                // $("#uid").val(ZyUid);
                // $("#username").val(username);
                // $("#password").val(password);
                // $("#channelUid").val(channelUid);
                //
                // $("#reg_username").val("");
                // $("#reg_password").val("");
                //
                let res = "账号: " + username + " 密码: " + password + " Uid: " + channelUid;
                $('#copy').val(res);
                setCookie("zy_account", username);
                setCookie("zy_password", password);
                setCookie("zy_channelUid", channelUid);
                // showLoginPage();
            }
        })
    }

    /**
     * 渠道账号自动注册指悦账号
     * @param regInfo
     * @param regInfo.appId
     * @param regInfo.channelId
     * @param regInfo.channelUid
     * @param regInfo.channelUname
     * @param regInfo.channelUnick
     * @param regInfo.phone
     * @param regInfo.deviceCode
     * @param callback
     * */
    function sdk_AutoReg(regInfo, callback) {
        console.log(regInfo);
        let rspObject = {};
        let mustKey = ['appId', 'channelId', 'channelUid'];
        for (let keyIndex of mustKey) {
            if (!regInfo.hasOwnProperty(keyIndex)) {
                rspObject.message = "参数:" + mustKey[keyIndex] + " 为空";
                rspObject.state = false;
                callback(rspObject);
                return;
            }
        }

        $.ajax({
            url: "/zysdk" + "/webGame2/autoReg",
            type: "post",
            contentType: "text/plain; charset=utf-8",
            data: JSON.stringify(regInfo),
            dataType: "json",
            async: false,
            success: function (result) {
                console.info(result);
                if (result.hasOwnProperty('state')) {
                    if (result.state === true) {
                        rspObject.state = true;
                        rspObject.message = result.message;

                        rspObject.uid = result.accountId;
                        rspObject.account = result.account;
                        rspObject.password = result.password;
                        rspObject.channelUid = result.channelUid;
                    } else {
                        rspObject.state = false;
                        rspObject.message = result.message;
                    }
                } else {
                    rspObject.state = false;
                    rspObject.message = "通信失败";
                }
                callback(rspObject);
            },
            error: function () {
                rspObject.message = "通信失败";
                rspObject.state = false;
                callback(rspObject);
            }
        });
    }

    function updateQueryStringParameter(uri, key, value) {
        if (value === "" || value === undefined) {
            return uri;
        }
        let re = new RegExp("([?&])" + key + "=.*?(&|$)", "i");
        let separator = uri.indexOf('?') !== -1 ? "&" : "?";
        if (uri.match(re)) {
            return uri.replace(re, '$1' + key + "=" + value + '$2');
        } else {
            return uri + separator + key + "=" + value;
        }
    }
</script>

</body>

</html>
